# Requirements Document

## Introduction
本ドキュメントは、ジェスチャー軌跡に基づく音声パラメータ算出ロジックの改善要件を定義する。現行の仕様では始点のY座標でピッチが決定され、始点-終点間の直線距離で再生時間が決定されるが、本機能変更により以下を実現する：
1. 軌跡上のY座標位置でピッチを決定（画面上部=高音、画面下部=低音）
2. 曲線軌跡に沿ってピッチが動的に変化（累積距離ベースで進行）
3. 軌跡の総線分長（パスに沿った実際の距離）で再生時間を決定
4. X座標の方向（左右）による再生方向の違いを廃止し、常に順再生とする

※ピッチ変更にはWeb Audio APIのplaybackRateを使用するため、ピッチと再生速度は連動する（高音=速い、低音=遅い）

## Requirements

### Requirement 1: Y座標位置に基づくピッチ計算
**Objective:** As a ユーザー, I want 軌跡上のY座標位置でピッチが決まる, so that 画面上部で高音、画面下部で低音という直感的な操作ができる

#### Acceptance Criteria
1. The アプリケーション shall 軌跡上の各点のY座標に基づいてピッチを算出する
2. When 軌跡上の点がキャンバス上端に近い（Y座標が小さい）場合, the アプリケーション shall 高いピッチ（最大5倍）で再生する
3. When 軌跡上の点がキャンバス下端に近い（Y座標が大きい）場合, the アプリケーション shall 低いピッチ（最小1倍）で再生する
4. When 軌跡上の点がキャンバス中央の場合, the アプリケーション shall 中間のピッチで再生する
5. The アプリケーション shall Y座標とピッチの関係を線形に維持する
6. The アプリケーション shall ピッチ変化の範囲を1倍（元のピッチ）から5倍に制限する

### Requirement 2: 軌跡に沿った動的ピッチ変化
**Objective:** As a ユーザー, I want 曲線を描いた時にピッチが軌跡に沿って変化する, so that 複雑なジェスチャーで表現力のある音声変調ができる

#### Acceptance Criteria
1. The アプリケーション shall 軌跡の各点のY座標と累積距離を記録する
2. The アプリケーション shall 音声再生中に軌跡の累積距離に基づいてピッチを動的に変更する
3. When 再生位置が軌跡全体のN%に達した場合, the アプリケーション shall 累積距離N%の位置のY座標に基づくピッチを適用する
4. When 軌跡が上方向に向かう区間, the アプリケーション shall その区間でピッチを上昇させる
5. When 軌跡が下方向に向かう区間, the アプリケーション shall その区間でピッチを下降させる
6. The アプリケーション shall ピッチの変化を滑らかに補間して急激な変動を防ぐ

### Requirement 3: 軌跡総線分長に基づく再生時間計算
**Objective:** As a ユーザー, I want 描いた軌跡の実際の長さ（曲線に沿った距離）で再生時間が決まる, so that 曲がりくねった線でも正確に長さが反映される

#### Acceptance Criteria
1. The アプリケーション shall 軌跡を構成する全セグメント（隣接する2点間）の長さを合計して総線分長を算出する
2. The アプリケーション shall 各セグメントの長さをユークリッド距離として計算する
3. When 同じ始点と終点で曲線軌跡を描いた場合, the アプリケーション shall 直線軌跡より長い再生時間を算出する
4. The アプリケーション shall 総線分長とキャンバス幅の半分の比率で再生時間倍率を決定する（既存のduration-ratio-canvas仕様を継承）
5. The アプリケーション shall 軌跡が記録されていない場合（始点と終点のみ）、始点-終点間の直線距離を使用する
6. The アプリケーション shall ピッチ変更による再生速度変化を許容する（高音区間は速く、低音区間は遅く再生される）

### Requirement 4: 再生方向の統一
**Objective:** As a ユーザー, I want X座標の方向に関わらず同じ再生処理が行われる, so that 操作がシンプルで予測可能になる

#### Acceptance Criteria
1. The アプリケーション shall X座標の方向（左向き/右向き）に関わらず常に順再生する
2. The アプリケーション shall 逆再生機能を廃止する
3. The アプリケーション shall 軌跡を描いた順序（始点→終点）で音声を再生しピッチを変化させる

### Requirement 5: 後方互換性の維持
**Objective:** As a 開発者, I want 既存のAPIインターフェースとの互換性を維持する, so that 他のコンポーネントへの影響を最小限に抑えられる

#### Acceptance Criteria
1. The アプリケーション shall 既存のキャンバス描画・軌跡記録ロジックを再利用する
2. The アプリケーション shall Web Audio APIのplaybackRateを活用してピッチ変更を実現する
3. If 動的ピッチ変化が技術的に困難な場合, then the アプリケーション shall 軌跡の平均Y座標による静的ピッチ計算にフォールバックする
